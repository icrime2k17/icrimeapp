<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
        <!--<meta http-equiv="Content-Security-Policy" content="default-src * data:; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'">-->
        <!--<script src="components/loader.js"></script>-->
        <script src="lib/onsenui/js/onsenui.min.js"></script>
        <script src="js/jquery-1.12.3.min.js"></script>
        <script src="js/MVCParser.js"></script>
        <script src="js/SessionParser.js"></script>
        <script src="js/config.js"></script>
        <script src="js/script.js"></script>
        <script src="js/camupload.js"></script>

        <link rel="stylesheet" href="components/loader.css">
        <link rel="stylesheet" href="lib/onsenui/css/onsenui.css">
        <link rel="stylesheet" href="lib/onsenui/css/onsen-css-components.css">
        <link rel="stylesheet" href="css/style.css">
        <link rel="stylesheet" href="css/loader.css">

        <script>
            ons.ready(function () {
                console.log("Onsen UI is ready!");
                checklogin();
                
                loadGoogleMaps();
            });
            
            function loadGoogleMaps(){
                var script_tag = document.createElement('script');
                script_tag.setAttribute("type","text/javascript");
                script_tag.setAttribute("src","https://maps.googleapis.com/maps/api/js?libraries=places&key=AIzaSyBt7c-kXucRO6GyORCLgGT2_GNzDuiZ4mk&callback=initMap");
                (document.getElementsByTagName("head")[0] || document.documentElement).appendChild(script_tag);
            }
            
            function initMap() 
            {
                window.mapMenuMode = sp.get('menuMode');
                var qc = {lat: 14.676041, lng: 121.043700};
                window.map = new google.maps.Map(document.getElementById('map'), {
                  zoom: 12,
                  center: qc,
                  disableDefaultUI: true
                });
                window.gmgeocoder = new google.maps.Geocoder();
                var infoWindow = new google.maps.InfoWindow({map: map});
                infoWindow.close();
                //AutoComplete Code
                var inputSearch = document.getElementById('search');
                var autocomplete = new google.maps.places.Autocomplete(inputSearch);
                autocomplete.bindTo('bounds', map);
                var searchMarker = new google.maps.Marker({
                  map: map,
                  anchorPoint: new google.maps.Point(0, -29)
                });

                autocomplete.addListener('place_changed', function() {
                  infoWindow.close();
                  searchMarker.setVisible(false);
                  var place = autocomplete.getPlace();
                  if (!place.geometry) {
                    // User entered the name of a Place that was not suggested and
                    // pressed the Enter key, or the Place Details request failed.
                    window.alert("Please refer to the suggested places on dropdown.");
                    return;
                  }

                  // If the place has a geometry, then present it on a map.
                  if (place.geometry.viewport) {
                    map.fitBounds(place.geometry.viewport);
                  } else {
                    map.setCenter(place.geometry.location);
                    map.setZoom(17);  // Why 17? Because it looks good.
                  }
                  searchMarker.setIcon(/** @type {google.maps.Icon} */({
                    url: place.icon,
                    size: new google.maps.Size(71, 71),
                    origin: new google.maps.Point(0, 0),
                    anchor: new google.maps.Point(17, 34),
                    scaledSize: new google.maps.Size(35, 35)
                  }));
                  searchMarker.setPosition(place.geometry.location);
                  searchMarker.setVisible(true);

                  var address = '';
                  if (place.address_components) {
                    address = [
                      (place.address_components[0] && place.address_components[0].short_name || ''),
                      (place.address_components[1] && place.address_components[1].short_name || ''),
                      (place.address_components[2] && place.address_components[2].short_name || '')
                    ].join(' ');
                  }

                  infoWindow.setContent('<div><strong>' + place.name + '</strong><br>' + address);
                  infoWindow.open(map, searchMarker);
                });

                //End of AutoComplete Code

              // Try HTML5 geolocation.
                if (navigator.geolocation) {
                  navigator.geolocation.getCurrentPosition(function(position) {
                    var pos = {
                      lat: position.coords.latitude,
                      lng: position.coords.longitude
                    };

                    CURRENT_POSITION = pos;
                    var USER_PIN = {
                        url: 'img/map/user.svg', // url
                        scaledSize: new google.maps.Size(50, 50), // scaled size
                        origin: new google.maps.Point(0,0), // origin
                    };
                    
                    var marker = new google.maps.Marker({
                        position: pos,
                        map: map,
                        draggable: false,
                        icon: USER_PIN,
                        optimized: false
                    });
            //          infoWindow.setPosition(pos);
            //          infoWindow.setContent('Location found.');
                    map.setCenter(pos);
                    map.setZoom(16);
                  }, function() {
                    handleLocationError(true, infoWindow, map.getCenter());
                  });
                } else {
                  // Browser doesn't support Geolocation
                  handleLocationError(false, infoWindow, map.getCenter());
                }
                
                if(sp.get('menuMode') == 4)
                {
                    LoadPoliceStations();
                }
            }
            
            function handleLocationError(browserHasGeolocation, infoWindow, pos) {
        //      infoWindow.setPosition(pos);
        //      infoWindow.setContent(browserHasGeolocation ?
        //                            'Error: The Geolocation service failed.' :
        //                            'Error: Your browser doesn\'t support geolocation.');
            }


            window.fn = {};
            window.fn.open = function () {
                var menu = document.getElementById('menu');
                menu.open();
            };
            
            
            window.fn.load = function (page,menu) {
                var menus = [];
                menus[1] = "Blotter";
                menus[2] = "Create a Blotter";
                menus[3] = "Report a Crime";
                menus[4] = "Police Stations";
                menuMode(menu);
                var content = document.getElementById('content');
                var menu = document.getElementById('menu');
                content
                        .load(page)
                        .then(menu.close.bind(menu));
                    loadGoogleMaps();
            };
        </script>
    </head>
    <body>
        <div class="loader">
            <div class="loader-graphic">
                <svg class="circle-loader progress" width="40" height="40" version="1.1" xmlns="http://www.w3.org/2000/svg">
                <circle cx="20" cy="20" r="15">
                </svg>
            </div>
        </div>
    <ons-splitter>
        <ons-splitter-side id="menu" side="left" width="220px" collapse>
            <ons-page>
                <ons-list>
                    <ons-list-item onclick = "fn.load('blotter.html',1)" tappable>
                        Blotters
                    </ons-list-item>
                    <ons-list-item class="create-blotter hidden" onclick="fn.load('createblotter.html',2)" tappable>
                        Create a Blotter
                    </ons-list-item>
                    <ons-list-item class="report-a-crime hidden" onclick="fn.load('reportcrime.html',3)" tappable>
                        Report a Crime
                    </ons-list-item>
                    <ons-list-item onclick="fn.load('policestation.html',4)" tappable>
                        Police Stations
                    </ons-list-item>
                    <ons-list-item onclick="fn.load('wantedlist.html')" tappable>
                        Wanted List
                    </ons-list-item>
                    <ons-list-item onclick="fn.load('about.html')" tappable>
                        About
                    </ons-list-item>
                    <ons-list-item class="login hidden" onclick="login()" tappable>
                        Login
                    </ons-list-item>
                    <ons-list-item class="logout hidden" onclick="logout()" tappable>
                        Logout
                    </ons-list-item>
                </ons-list>
            </ons-page>
        </ons-splitter-side>
        <ons-splitter-content id="content" page="blotter.html"></ons-splitter-content>
    </ons-splitter>

    <ons-template id="blotter.html">
        <ons-page>
            <ons-toolbar>
                <div class="left">
                    <ons-toolbar-button onclick="fn.open()">
                        <ons-icon icon="ion-navicon, material:md-menu"></ons-icon>
                    </ons-toolbar-button>
                </div>
                <div class="center map-mode">
                    Blotter
                </div>
            </ons-toolbar>
            <input type="text" id="search">
            <div id="map">
            </div>
            
        </ons-page>
    </ons-template>
    
    <ons-template id="createblotter.html">
        <ons-page>
            <ons-toolbar>
                <div class="left">
                    <ons-toolbar-button onclick="fn.open()">
                        <ons-icon icon="ion-navicon, material:md-menu"></ons-icon>
                    </ons-toolbar-button>
                </div>
                <div class="center map-mode">
                    Create a Blotter
                </div>
            </ons-toolbar>
            <input type="text" id="search">
            <div id="map" class="crime-pin">
            </div>
            <ons-fab class="add-crime" data-mode="1" position="bottom right">
                <ons-icon icon="md-plus"></ons-icon>
            </ons-fab>
        </ons-page>
    </ons-template>
    
    <ons-template id="reportcrime.html">
        <ons-page>
            <ons-toolbar>
                <div class="left">
                    <ons-toolbar-button onclick="fn.open()">
                        <ons-icon icon="ion-navicon, material:md-menu"></ons-icon>
                    </ons-toolbar-button>
                </div>
                <div class="center map-mode">
                    Report a Crime
                </div>
            </ons-toolbar>
            <input type="text" id="search">
            <div id="map" class="crime-pin">
            </div>
            <ons-fab class="add-crime" data-mode="2" position="bottom right">
                <ons-icon icon="md-plus"></ons-icon>
            </ons-fab>
        </ons-page>
    </ons-template>
    
    <ons-template id="policestation.html">
        <ons-page>
            <ons-toolbar>
                <div class="left">
                    <ons-toolbar-button onclick="fn.open()">
                        <ons-icon icon="ion-navicon, material:md-menu"></ons-icon>
                    </ons-toolbar-button>
                </div>
                <div class="center map-mode">
                    Police Stations
                </div>
            </ons-toolbar>
            <input type="text" id="search">
            <div id="map">
            </div>
        </ons-page>
    </ons-template>

    <ons-template id="wantedlist.html">
        <ons-page>
            <ons-toolbar>
                <div class="left">
                    <ons-toolbar-button onclick="fn.open()">
                        <ons-icon icon="ion-navicon, material:md-menu"></ons-icon>
                    </ons-toolbar-button>
                </div>
                <div class="center">
                    Wanted List
                </div>
            </ons-toolbar>
        </ons-page>
    </ons-template>
    
    <ons-template id="about.html">
        <ons-page>
            <ons-toolbar>
                <div class="left">
                    <ons-toolbar-button onclick="fn.open()">
                        <ons-icon icon="ion-navicon, material:md-menu"></ons-icon>
                    </ons-toolbar-button>
                </div>
                <div class="center">
                    About
                </div>
            </ons-toolbar>
        </ons-page>
    </ons-template>
    
    <ons-template id="dialog.html">
        <ons-dialog id="report-form">
          <div style="text-align: left; padding: 10px;">
            <h4 class="no-margin">Report</h4>
            <p id="report-address">
            </p>
            <div style="height: 200px;overflow-y:scroll;">
                <ons-select id="typeofcrime" onchange="selectedCrime(event)">
                  <option value="snatching">Snatching</option>
                  <option value="robbery">Robbery</option>
                  <option value="theft">Theft</option>
                </ons-select>
                <textarea id="report-detail" placeholder="Detail" rows="5" style="width:95%;"></textarea>
                <ons-button onclick="capturePhoto();" class="continue-as-regular-user" style="width:98%;text-align:center;">
                    <ons-icon
                        icon="fa-camera"
                        size="20px"
                        fixed-width="false">
                    </ons-icon>
                    Take a picture
                </ons-button>
                <div id="captured-image-holder">
                    <img id="smallImage" src="">
                </div>
            </div>
            <p align="right">
                <ons-button onclick="upload_picture()">Submit Report</ons-button>
                <ons-button onclick="hideDialog('report-form')">Close</ons-button>
            </p>
          </div>
        </ons-dialog>
    </ons-template>
    
    <ons-template id="policedialog.html">
        <ons-dialog id="police-station">
          <div style="text-align: center; padding: 10px;">
            <p>
                <span class="s-name"></span>
                <span class="s-address"></span>
                <span class="s-phone"></span>
            <p>

            <p>
              <ons-button onclick="hideDialog('police-station')">Close</ons-button>
            </p>
          </div>
        </ons-dialog>
    </ons-template>
    
</body>
</html>
